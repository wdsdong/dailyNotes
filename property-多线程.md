#iOS 多线程到底不安全在哪里

###Property

给 property 加上 atomic attribute 后，可以一定程度的保障多线程安全

###Property 分类

值类型

对象类型：访问指针本身，访问指针指向的内存区域

###多线程如何访问内存

地址总线去内存读取。  
我们只有一个地址总线，一个内存。即使在多线程的情况下，也不可能存在两个线程同时访问同一块内存区域的场景，内存的访问一定是通过一个地址总线串行排队访问的。

>	结论一：内存的访问时串行的，并不会导致内存数据的错乱或者应用的	crash。

>	结论二：如果读写（load or store）的内存长度小于等于地址总线的长度，	那么读写的操作是原子的，一次完成。比如bool，int，long在64位系统下的	单次读写都是原子操作。

###三种property分析

* 值类型 Property

> 从访问内存的角度看nonatomic和atomic也并没有什么区别

* 指针类型 Property

> atomic和nonatomic在多线程安全上并没有实际差别

* 指针类型 Property 指向内存区域

> atomic并不能保证线程安全

###Property 小结

简而言之，atomic 的作用只是给 getter 和 setter 加了个锁，atomic 只能保证代码进入 getter 或者 setter 函数内部时时安全的，一旦出了 getter 和 setter，多线程安全只能靠程序员自己保障。所以 atomic 属性和使用 Property 的多线程安全并没有直接的联系。另外，atomic 由于加锁也会带来一些性能损耗，所以一般声明 Property 为 nonatomic，在需要多线程安全的场景，自己去额外加锁做同步

###如何做到多线程安全

关键字是atomicity（原子性），只要做到原子性，小到一个值类型变量的访问，大到一长段代码逻辑的执行，原子性能保证代码串行的执行，能保证代码执行到一半的时候，不会有另一个线程介入
